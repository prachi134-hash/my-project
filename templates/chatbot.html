<!-- Chatbot Widget -->
<div id="chatbot-widget">
  <!-- Robot Icon -->
  <div id="robot-icon" onclick="toggleChat()">ðŸ¤–</div>

  <!-- Chatbox -->
  <div id="chatbox">
    <div id="chat-header">
      CCEW Assistant
      <span id="close-chat" onclick="closeChat()">Ã—</span>
    </div>
    <div id="chat-messages"></div>
    <div id="chat-input">
      <input type="text" id="user-input" placeholder="Type your message..." onkeydown="if(event.key === 'Enter') sendMessage()">
      <button onclick="sendMessage()">Send</button>
      <button onclick="clearChat()" style="background:#f44336;">Clear</button>
    </div>
  </div>
</div>

<style>
  /* Chatbot Widget */
  #chatbot-widget { position: fixed; bottom: 20px; right: 20px; z-index: 9999; font-family: sans-serif; }
  #robot-icon { cursor: pointer; font-size: 50px; transition: transform 0.3s ease; }
  #robot-icon:hover { transform: scale(1.2); }
  #chatbox { width: 300px; max-height: 400px; background: #fff; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.3); display: none; flex-direction: column; overflow: hidden; margin-bottom: 10px; }
  #chat-header { background: #007bff; color: #fff; padding: 12px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
  #close-chat { cursor: pointer; font-size: 18px; font-weight: bold; }
  #chat-messages { flex: 1; overflow-y: auto; padding: 12px; max-height: 300px; }
  .message { margin-bottom: 5px; }
  .message.bot { background:#e1f5fe; padding:5px; border-radius:5px; }
  .message.user { background:#c8e6c9; padding:5px; border-radius:5px; text-align:right; }
  #chat-input { display: flex; gap: 8px; padding: 10px; border-top: 1px solid #ddd; }
  #user-input { flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #ccc; }
  #chat-input button { padding: 8px 14px; border: none; border-radius: 6px; color: white; cursor: pointer; transition: background 0.2s; }
  #chat-input button:first-of-type { background: #007bff; }
  #chat-input button:first-of-type:hover { background: #005bb5; }
  #chat-input button:last-of-type { background: #f44336; }
  #chat-input button:last-of-type:hover { background: #d32f2f; }
</style>

<script>
  const robotIcon = document.getElementById("robot-icon");
  const chatbox = document.getElementById("chatbox");
  const chatMessages = document.getElementById("chat-messages");
  const userInput = document.getElementById("user-input");

  let chatHistory = [];
  let chatOpen = localStorage.getItem("chatOpen") === "true";

  // Generate or retrieve persistent session ID
  let sessionId = localStorage.getItem("SessionId");
  if (!sessionId) {
    sessionId = 'sess_' + Date.now() + '_' + Math.floor(Math.random()*1000);
    localStorage.setItem("SessionId", sessionId);
  }

  async function loadChatHistory() {
    try {
      const response = await fetch("/chat_history", { headers: { "Session-Id": sessionId } });
      const data = await response.json();
      chatHistory = data.history;
      renderChat();
    } catch (err) {
      console.error("Failed to load chat history", err);
    }
  }

  function renderChat() {
    chatMessages.innerHTML = "";
    chatHistory.forEach(msg => {
      const div = document.createElement("div");
      div.className = `message ${msg.role}`;
      div.innerText = msg.text;
      chatMessages.appendChild(div);
    });
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function addBotMessage(msg) {
    chatHistory.push({ role: "bot", text: msg });
    renderChat();
  }

  function addUserMessage(msg) {
    chatHistory.push({ role: "user", text: msg });
    renderChat();
  }

  async function sendMessage() {
    const msg = userInput.value.trim();
    if (!msg) return;
    addUserMessage(msg);
    userInput.value = "";
    try {
      const response = await fetch("/chat", {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          "Session-Id": sessionId
        },
        body: JSON.stringify({ message: msg })
      });
      const data = await response.json();
      addBotMessage(data.reply);
    } catch (err) {
      console.error(err);
      addBotMessage("Sorry, something went wrong!");
    }
  }

  async function clearChat() {
    try {
      await fetch("/clear_chat", {
        method: "POST",
        headers: { "Session-Id": sessionId }
      });
      chatHistory = [];
      renderChat();
    } catch (err) {
      console.error("Failed to clear chat", err);
    }
  }

  function toggleChat() {
    if (chatbox.style.display === "flex") {
      chatbox.style.display = "none";
      localStorage.setItem("chatOpen", "false");
    } else {
      chatbox.style.display = "flex";
      localStorage.setItem("chatOpen", "true");
      loadChatHistory();
      if (chatHistory.length === 0) {
        addBotMessage("Hello! Iâ€™m your assistant ðŸ¤–. Ask me about clubs, sports, cultural activities, fests, or tech initiatives.");
      }
    }
  }

  function closeChat() {
    chatbox.style.display = "none";
    localStorage.setItem("chatOpen", "false");
  }

  document.addEventListener("DOMContentLoaded", () => {
    if (chatOpen) {
      chatbox.style.display = "flex";
      loadChatHistory();
    }
  });
</script>
